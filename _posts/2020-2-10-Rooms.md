---
layout: post
title: Rooms
img: images/placeholder2.png
forward: GameEvents
back: Gamemanager
tag: Creating a multiplayer game like Jackbox
---

We can now have multiple games on our server. In this part we are going to allow players to join a room.

SocketIO has a built in way to assign connections to a room. This is useful because it allows you to send messages to all clients inside a room.

This tutorial continues with the code from the previous part. You can get the finished project from the last part [here](https://github.com/RubenBimmel/MultiplayerGameTutorial/tree/master/04-Gamemanager).

## Checking available rooms on the server

In this game, players are able to enter their name and a room id on the homescreen. If the room exists the players will be forwarded to the controller page. To do this the homepage also needs to communicate with the server. Let's start by adding socketIO to the homescreen as well.

Create a new script called `homepage.js` inside the `js` folder. Add the following lines of code to `index.html`.

```html
<script src="/socket.io/socket.io.js"></script>
<script src="js/homepage.js"></script>
```

Add the following code to `homepage.js`.

```js
var socket = io();

var nameInput = document.getElementById("name");
var roomInput = document.getElementById("room");

document.getElementById("join").onclick = () => {
    if (nameInput.value) {
        nameInput.style.border = "";
        socket.emit ('checkRoom', roomInput.value);
    } else {
        nameInput.style.border = "1px solid red";
    }
}
```
This code will add a listener to the join button. When pressed it first validates the info by checking if the name input field is not empty. It then emits an event to the server with a request to check if the room exists. Let's create a respond on the server. First create a new function to `gamemanager.js` to check if a room exists.

```js
function roomExists(id) {
    return games[id] != undefined;
}

module.exports = {
    createRoom: createRoom,
    removeRoom: removeRoom,
    roomExists: roomExists
}
```

Add the following lines of code to the socket connection event in `index.js`.

```js
socket.on('checkRoom', function(id) {
    socket.emit('roomExists', gamemanager.roomExists(id));
});
```

Now we can listen to this event in `homepage.js` and forward the player to the controller page if the room is available.

```js
socket.on('roomExists', function(result) {
    if (result) {
        window.location.href = "controller";
    } else {
        roomInput.style.border = "1px solid red";
    }
});
```

We are going to need the values of our name and room input fields on our controller page. To do this we can add them to the session storage.

```js
socket.on('roomExists', function(result) {
    if (result) {
        sessionStorage.setItem('name', nameInput.value);
        sessionStorage.setItem('room', roomInput.value);
        window.location.href = "controller";
    } else {
        roomInput.style.border = "1px solid red";
    }
});
```

## Sending a join event to the server
Now add the following code to `controller.js`.

```js
var name = sessionStorage.getItem("name");
var room = sessionStorage.getItem("room");

if (name && room) {
    socket.emit('join', {name: name, room: room});
} else {
    window.location.href = "/";
}

socket.on('joinFailed', () => {
    window.location.href = "/";
});
```

This will get the name and room entered in the homepage out of the session storage. If a player went directly to this page the session storage will be empty. In this case the player will be redirected to the homepage. We will also redirect the player to the homepage if the join request failed. To do this we will listen to a joinfailed request.

We can now listen to this event on the server. Add the following code to `index.js`.

```js
socket.on('join', function(data) {
    if (gamemanager.roomExists(data.room)) {
        gamemanager.joinRoom(data.room, socket, data.name);
    } else {
        socket.emit('joinFailed');
    }
});
```

We also need to add the joinRoom function to `gamemanager.js`.
```js
function joinRoom(room, socket, name) {
    games[room].addPlayer(socket, name);
}

module.exports = {
    createRoom: createRoom,
    removeRoom: removeRoom,
    roomExists: roomExists,
    joinRoom: joinRoom
}
```

## Sending events to rooms using SocketIO

So far we only emited events directly to sockets using `socket.emit()`. We can also emit events to multiple sockets at the same time. To do this we need to add sockets to a room.

To add a socket to a room we can use `socket.join('room name')`. After that we can emit events to all sockets inside a room using `io.to('room name').emit()`.

Let's add the following lines of code to make sure that the host and the players will be added to the same socketIO room.

```js
addHost(socket) {
    this.host = socket.id;
    socket.emit('room', this.id);
    socket.join(this.id);
}

addPlayer(socket, name) {
    this.players.push ({
        id: socket.id,
        name: name
    })
    socket.join(this.id);
}
```

We cannot send messages to the room from within the gamemanager module yet because this module has nog acces to the `io` object. Instead we will add the handle directly to the room after it is created by `index.js` and store it in `game.room`.

```js
socket.on('host', function() {
    var game = gamemanager.createRoom();
    game.addHost(socket);
    game.room = io.to(game.id);
    socket.on('disconnect', () => gamemanager.removeRoom(game.id));
});
```

We can now emit events to all connected sockets inside an instance of a game class using `this.room.emit()`.

[View code](https://github.com/RubenBimmel/MultiplayerGameTutorial/tree/master/05-Rooms)

## Learn more about SocketIO events

SocketIO has a lot more options to send events to specific or multiple sockets. You can find an overview of this on their website:

[SocketIO - Emit cheatsheet](https://socket.io/docs/emit-cheatsheet/)

Beside rooms you can also make use of namespaces. You can find a detailed description of rooms and namespaces and their differences on the socketIO website as well:

[SocketIO - Rooms and Namespaces](https://socket.io/docs/rooms-and-namespaces/)